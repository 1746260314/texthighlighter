/*
 jQuery Text Highlighter
 Copyright (C) 2012 by mirz

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
*/
(function(b,t,r,s){var p,q;function v(d,e){this.context=d;this.$context=b(d);this.options=b.extend({},b[p].defaults,e);this.init()}q=1;p="textHighlighter";v.prototype={init:function(){this.$context.addClass(this.options.contextClass);this.bindEvents()},destroy:function(){this.unbindEvents();this.$context.removeClass(this.options.contextClass);this.$context.removeData(p)},bindEvents:function(){this.$context.bind("mouseup",{self:this},this.highlightHandler)},unbindEvents:function(){this.$context.unbind("mouseup",
this.highlightHandler)},highlightHandler:function(b){b.data.self.doHighlight()},doHighlight:function(){var d=this.getCurrentRange();if(d&&!d.collapsed&&this.isRangeInsideContext(d)){if(!0==this.options.onBeforeHighlight(d)){var e=b.textHighlighter.createWrapper(this.options);this.options.onAfterHighlight(this.normalizeHighlights(this.highlightRange(d,e)))}this.removeAllRanges()}},getCurrentRange:function(){var b=this.getCurrentSelection(),e;0<b.rangeCount&&(e=b.getRangeAt(0));return e},removeAllRanges:function(){this.getCurrentSelection().removeAllRanges()},
getCurrentSelection:function(){var d=this.getCurrentWindow(),e;d.getSelection?e=d.getSelection():b("iframe")?b("iframe",top.document).each(function(){if(this.contentWindow===d)return e=rangy.getIframeSelection(this),!1}):e=rangy.getSelection();return e},getCurrentWindow:function(){var b=this.getCurrentDocument();return b.defaultView?b.defaultView:b.parentWindow},getCurrentDocument:function(){return this.context.ownerDocument?this.context.ownerDocument:this.context},isRangeInsideContext:function(d){var e=
b.contains(this.context,d.startContainer),d=b.contains(this.context,d.endContainer);return e&&d},highlightRange:function(d,e){if(!d.collapsed){var k="SCRIPT STYLE SELECT BUTTON OBJECT APPLET".split(" "),l=d.startContainer,m=d.endContainer,o=d.commonAncestorContainer,i=!0;if(0==d.endOffset){for(;!m.previousSibling&&m.parentNode!=o;)m=m.parentNode;m=m.previousSibling}else 3==m.nodeType?d.endOffset<m.nodeValue.length&&m.splitText(d.endOffset):0<d.endOffset&&(m=m.childNodes.item(d.endOffset-1));3==l.nodeType?
d.startOffset==l.nodeValue.length?i=!1:0<d.startOffset&&(l=l.splitText(d.startOffset),m==l.previousSibling&&(m=l)):l=d.startOffset<l.childNodes.length?l.childNodes.item(d.startOffset):l.nextSibling;var o=!1,n=[];do{i&&3==l.nodeType&&(/\S/.test(l.nodeValue)&&(i=e.clone(!0).get(0),i=b(l).wrap(i).parent().get(0),n.push(i)),i=!1);if(l==m&&(!m.hasChildNodes()||!i))o=!0;-1!=b.inArray(l.tagName,k)&&(i=!1);i&&l.hasChildNodes()?l=l.firstChild:null!=l.nextSibling?(l=l.nextSibling,i=!0):(l=l.parentNode,i=!1)}while(!o);
return n}},normalizeHighlights:function(d){this.flattenNestedHighlights(d);this.mergeSiblingHighlights(d);return b.map(d,function(b){return"undefined"!=typeof b.parentElement?null!=b.parentElement?b:null:null!=b.parentNode?b:null})},flattenNestedHighlights:function(d){var e=this;b.each(d,function(k){var l=b(this);if(l.parent().hasClass(e.options.highlightedClass)){var l=l.parent(),m=l.text(),m=r.createTextNode(m);l.empty();l.append(m);b(d[k]).remove()}})},mergeSiblingHighlights:function(d){function e(e){return e&&
e.nodeType==q&&b(e).hasClass(k.options.highlightedClass)?!0:!1}var k=this;b.each(d,function(){var k=this.previousSibling,d=this.nextSibling;if(e(k)){var o=b(k).text()+b(this).text();b(this).text(o);b(k).remove()}e(d)&&(o=b(this).text()+b(d).text(),b(this).text(o),b(d).remove())})},setColor:function(b){this.options.color=b},getColor:function(){return this.options.color},removeHighlights:function(d){var e=this;this.getAllHighlights(d!=s?d:this.context,!0).each(function(){if(!0==e.options.onRemoveHighlight(this)){var k=
b(this).contents().unwrap().get(0),l=k.previousSibling,d=k.nextSibling;l&&3==l.nodeType&&(k.nodeValue=l.nodeValue+k.nodeValue,l.parentNode.removeChild(l));d&&3==d.nodeType&&(k.nodeValue+=d.nodeValue,d.parentNode.removeChild(d))}})},getAllHighlights:function(d,e){var k="."+this.options.highlightedClass,k=b(d).find(k);!0==e&&b(d).hasClass(this.options.highlightedClass)&&(k=k.add(d));return k}};b.fn.getHighlighter=function(){return this.data(p)};b.fn[p]=function(d){return this.each(function(){b.data(this,
p)||b.data(this,p,new v(this,d))})};b.textHighlighter={createWrapper:function(d){return b("<span></span>").css("backgroundColor",d.color).addClass(d.highlightedClass)},defaults:{color:"#ffff7b",highlightedClass:"highlighted",contextClass:"highlighter-context",onRemoveHighlight:function(){return!0},onBeforeHighlight:function(){return!0},onAfterHighlight:function(){}}};b.textHighlighter.createWrapper=function(d){return b("<span>").css("backgroundColor",d.color).addClass(d.highlightedClass)}})(jQuery,
window,document);window.rangy=function(){function b(c,b){var h=typeof c[b];return"function"==h||!!("object"==h&&c[b])||"unknown"==h}function t(c,h){return!!("object"==typeof c[h]&&c[h])}function r(c,h){return"undefined"!=typeof c[h]}function s(c){return function(h,b){for(var e=b.length;e--;)if(!c(h,b[e]))return!1;return!0}}function p(c){return c&&o(c,m)&&n(c,l)}function q(h){window.alert("Rangy not supported in your browser. Reason: "+h);c.initialized=!0;c.supported=!1}function v(){if(!c.initialized){var d,l=!1,i=
!1;b(document,"createRange")&&(d=document.createRange(),o(d,k)&&n(d,e)&&(l=!0),d.detach());if((d=t(document,"body")?document.body:document.getElementsByTagName("body")[0])&&b(d,"createTextRange"))d=d.createTextRange(),p(d)&&(i=!0);!l&&!i&&q("Neither Range nor TextRange are implemented");c.initialized=!0;c.features={implementsDomRange:l,implementsTextRange:i};l=z.concat(h);i=0;for(d=l.length;i<d;++i)try{l[i](c)}catch(m){t(window,"console")&&b(window.console,"log")&&window.console.log("Init listener threw an exception. Continuing.",
m)}}}function d(c){this.name=c;this.supported=this.initialized=!1}var e="startContainer startOffset endContainer endOffset collapsed commonAncestorContainer START_TO_START START_TO_END END_TO_START END_TO_END".split(" "),k="setStart setStartBefore setStartAfter setEnd setEndBefore setEndAfter collapse selectNode selectNodeContents compareBoundaryPoints deleteContents extractContents cloneContents insertNode surroundContents cloneRange toString detach".split(" "),l="boundingHeight boundingLeft boundingTop boundingWidth htmlText text".split(" "),
m="collapse compareEndPoints duplicate getBookmark moveToBookmark moveToElementText parentElement pasteHTML select setEndPoint getBoundingClientRect".split(" "),o=s(b),i=s(t),n=s(r),c={version:"1.2.3",initialized:!1,supported:!0,util:{isHostMethod:b,isHostObject:t,isHostProperty:r,areHostMethods:o,areHostObjects:i,areHostProperties:n,isTextRange:p},features:{},modules:{},config:{alertOnWarn:!1,preferTextRange:!1}};c.fail=q;c.warn=function(h){h="Rangy warning: "+h;c.config.alertOnWarn?window.alert(h):
"undefined"!=typeof window.console&&"undefined"!=typeof window.console.log&&window.console.log(h)};({}).hasOwnProperty?c.util.extend=function(c,h){for(var b in h)h.hasOwnProperty(b)&&(c[b]=h[b])}:q("hasOwnProperty not supported");var h=[],z=[];c.init=v;c.addInitListener=function(b){c.initialized?b(c):h.push(b)};var y=[];c.addCreateMissingNativeApiListener=function(c){y.push(c)};c.createMissingNativeApi=function(c){c=c||window;v();for(var h=0,b=y.length;h<b;++h)y[h](c)};d.prototype.fail=function(c){this.initialized=
!0;this.supported=!1;throw Error("Module '"+this.name+"' failed to load: "+c);};d.prototype.warn=function(h){c.warn("Module "+this.name+": "+h)};d.prototype.createError=function(c){return Error("Error in Rangy "+this.name+" module: "+c)};c.createModule=function(h,b){var e=new d(h);c.modules[h]=e;z.push(function(c){b(c,e);e.initialized=!0;e.supported=!0})};c.requireModules=function(h){for(var b=0,e=h.length,k,l;b<e;++b){l=h[b];k=c.modules[l];if(!k||!(k instanceof d))throw Error("Module '"+l+"' not found");
if(!k.supported)throw Error("Module '"+l+"' not supported");}};var B=!1,i=function(){B||(B=!0,c.initialized||v())};if("undefined"==typeof window)q("No window found");else if("undefined"==typeof document)q("No document found");else return b(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",i,!1),b(window,"addEventListener")?window.addEventListener("load",i,!1):b(window,"attachEvent")?window.attachEvent("onload",i):q("Window does not have required addEventListener or attachEvent method"),
c}();
rangy.createModule("DomUtil",function(b,t){function r(c){for(var h=0;c=c.previousSibling;)h++;return h}function s(c,h){var b=[],e;for(e=c;e;e=e.parentNode)b.push(e);for(e=h;e;e=e.parentNode)if(n(b,e))return e;return null}function p(c,h,b){for(b=b?c:c.parentNode;b;){c=b.parentNode;if(c===h)return b;b=c}return null}function q(c){c=c.nodeType;return 3==c||4==c||8==c}function v(c,h){var b=h.nextSibling,e=h.parentNode;b?e.insertBefore(c,b):e.appendChild(c);return c}function d(c){if(9==c.nodeType)return c;if("undefined"!=
typeof c.ownerDocument)return c.ownerDocument;if("undefined"!=typeof c.document)return c.document;if(c.parentNode)return d(c.parentNode);throw Error("getDocument: no document found for node");}function e(c){return!c?"[No node]":q(c)?'"'+c.data+'"':1==c.nodeType?"<"+c.nodeName+(c.id?' id="'+c.id+'"':"")+">["+c.childNodes.length+"]":c.nodeName}function k(c){this._next=this.root=c}function l(c,b){this.node=c;this.offset=b}function m(c){this.code=this[c];this.codeName=c;this.message="DOMException: "+
this.codeName}var o=b.util;o.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||t.fail("document missing a Node creation method");o.isHostMethod(document,"getElementsByTagName")||t.fail("document missing getElementsByTagName method");var i=document.createElement("div");o.areHostMethods(i,["insertBefore","appendChild","cloneNode"])||t.fail("Incomplete Element implementation");o.isHostProperty(i,"innerHTML")||t.fail("Element is missing innerHTML property");i=document.createTextNode("test");
o.areHostMethods(i,["splitText","deleteData","insertData","appendData","cloneNode"])||t.fail("Incomplete Text Node implementation");var n=function(c,b){for(var e=c.length;e--;)if(c[e]===b)return!0;return!1};k.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var c=this._current=this._next,b;if(this._current){if(!(b=c.firstChild))for(b=null;c!==this.root&&!(b=c.nextSibling);)c=c.parentNode;this._next=b}return this._current},detach:function(){this._current=this._next=this.root=
null}};l.prototype={equals:function(c){return this.node===c.node&this.offset==c.offset},inspect:function(){return"[DomPosition("+e(this.node)+":"+this.offset+")]"}};m.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11};m.prototype.toString=function(){return this.message};b.dom={arrayContains:n,isHtmlNamespace:function(c){var b;return"undefined"==typeof c.namespaceURI||null===(b=c.namespaceURI)||
"http://www.w3.org/1999/xhtml"==b},parentElement:function(c){c=c.parentNode;return 1==c.nodeType?c:null},getNodeIndex:r,getNodeLength:function(c){var b;return q(c)?c.length:(b=c.childNodes)?b.length:0},getCommonAncestor:s,isAncestorOf:function(c,b,e){for(b=e?b:b.parentNode;b;){if(b===c)return!0;b=b.parentNode}return!1},getClosestAncestorIn:p,isCharacterDataNode:q,insertAfter:v,splitDataNode:function(c,b){var e=c.cloneNode(!1);e.deleteData(0,b);c.deleteData(b,c.length-b);v(e,c);return e},getDocument:d,
getWindow:function(c){c=d(c);if("undefined"!=typeof c.defaultView)return c.defaultView;if("undefined"!=typeof c.parentWindow)return c.parentWindow;throw Error("Cannot get a window object for node");},getIframeWindow:function(c){if("undefined"!=typeof c.contentWindow)return c.contentWindow;if("undefined"!=typeof c.contentDocument)return c.contentDocument.defaultView;throw Error("getIframeWindow: No Window object found for iframe element");},getIframeDocument:function(c){if("undefined"!=typeof c.contentDocument)return c.contentDocument;
if("undefined"!=typeof c.contentWindow)return c.contentWindow.document;throw Error("getIframeWindow: No Document object found for iframe element");},getBody:function(c){return o.isHostObject(c,"body")?c.body:c.getElementsByTagName("body")[0]},getRootContainer:function(c){for(var b;b=c.parentNode;)c=b;return c},comparePoints:function(c,b,e,d){var k;if(c==e)return b===d?0:b<d?-1:1;if(k=p(e,c,!0))return b<=r(k)?-1:1;if(k=p(c,e,!0))return r(k)<d?-1:1;b=s(c,e);c=c===b?b:p(c,b,!0);e=e===b?b:p(e,b,!0);if(c===
e)throw Error("comparePoints got to case 4 and childA and childB are the same!");for(b=b.firstChild;b;){if(b===c)return-1;if(b===e)return 1;b=b.nextSibling}throw Error("Should not be here!");},inspectNode:e,fragmentFromNodeChildren:function(b){for(var e=d(b).createDocumentFragment(),k;k=b.firstChild;)e.appendChild(k);return e},createIterator:function(b){return new k(b)},DomPosition:l};b.DOMException=m});
rangy.createModule("DomRange",function(b){function t(f,a){return 3!=f.nodeType&&(g.isAncestorOf(f,a.startContainer,!0)||g.isAncestorOf(f,a.endContainer,!0))}function r(f){return g.getDocument(f.startContainer)}function s(f,a,b){if(a=f._listeners[a])for(var c=0,j=a.length;c<j;++c)a[c].call(f,{target:f,args:b})}function p(f){return new H(f.parentNode,g.getNodeIndex(f))}function q(f){return new H(f.parentNode,g.getNodeIndex(f)+1)}function v(f,a,b){var c=11==f.nodeType?f.firstChild:f;g.isCharacterDataNode(a)?
b==a.length?g.insertAfter(f,a):a.parentNode.insertBefore(f,0==b?a:g.splitDataNode(a,b)):b>=a.childNodes.length?a.appendChild(f):a.insertBefore(f,a.childNodes[b]);return c}function d(f){for(var a,b,c=r(f.range).createDocumentFragment();b=f.next();){a=f.isPartiallySelectedSubtree();b=b.cloneNode(!a);a&&(a=f.getSubtreeIterator(),b.appendChild(d(a)),a.detach(!0));if(10==b.nodeType)throw new A("HIERARCHY_REQUEST_ERR");c.appendChild(b)}return c}function e(f,a,b){for(var c,j,b=b||{stop:!1};c=f.next();)if(f.isPartiallySelectedSubtree())if(!1===
a(c)){b.stop=!0;break}else{if(c=f.getSubtreeIterator(),e(c,a,b),c.detach(!0),b.stop)break}else for(c=g.createIterator(c);j=c.next();)if(!1===a(j)){b.stop=!0;return}}function k(f){for(var a;f.next();)f.isPartiallySelectedSubtree()?(a=f.getSubtreeIterator(),k(a),a.detach(!0)):f.remove()}function l(f){for(var a,b=r(f.range).createDocumentFragment(),c;a=f.next();){f.isPartiallySelectedSubtree()?(a=a.cloneNode(!1),c=f.getSubtreeIterator(),a.appendChild(l(c)),c.detach(!0)):f.remove();if(10==a.nodeType)throw new A("HIERARCHY_REQUEST_ERR");
b.appendChild(a)}return b}function m(f,a,b){var c=!(!a||!a.length),j,h=!!b;c&&(j=RegExp("^("+a.join("|")+")$"));var k=[];e(new i(f,!1),function(f){(!c||j.test(f.nodeType))&&(!h||b(f))&&k.push(f)});return k}function o(f){return"["+("undefined"==typeof f.getName?"Range":f.getName())+"("+g.inspectNode(f.startContainer)+":"+f.startOffset+", "+g.inspectNode(f.endContainer)+":"+f.endOffset+")]"}function i(f,a){this.range=f;this.clonePartiallySelectedTextNodes=a;if(!f.collapsed){this.sc=f.startContainer;
this.so=f.startOffset;this.ec=f.endContainer;this.eo=f.endOffset;var b=f.commonAncestorContainer;this.sc===this.ec&&g.isCharacterDataNode(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc===b&&!g.isCharacterDataNode(this.sc)?this.sc.childNodes[this.so]:g.getClosestAncestorIn(this.sc,b,!0),this._last=this.ec===b&&!g.isCharacterDataNode(this.ec)?this.ec.childNodes[this.eo-1]:g.getClosestAncestorIn(this.ec,b,!0))}}function n(f){this.code=
this[f];this.codeName=f;this.message="RangeException: "+this.codeName}function c(f,a,b){this.nodes=m(f,a,b);this._next=this.nodes[0];this._position=0}function h(f){return function(a,b){for(var c,j=b?a:a.parentNode;j;){c=j.nodeType;if(g.arrayContains(f,c))return j;j=j.parentNode}return null}}function z(f,a){if(ba(f,a))throw new n("INVALID_NODE_TYPE_ERR");}function y(f){if(!f.startContainer)throw new A("INVALID_STATE_ERR");}function B(f,a){if(!g.arrayContains(a,f.nodeType))throw new n("INVALID_NODE_TYPE_ERR");
}function L(f,a){if(0>a||a>(g.isCharacterDataNode(f)?f.length:f.childNodes.length))throw new A("INDEX_SIZE_ERR");}function D(a,b){if(I(a,!0)!==I(b,!0))throw new A("WRONG_DOCUMENT_ERR");}function C(a){if(ca(a,!0))throw new A("NO_MODIFICATION_ALLOWED_ERR");}function x(a,b){if(!a)throw new A(b);}function F(a){return!!a.startContainer&&!!a.endContainer&&!(!g.arrayContains(M,a.startContainer.nodeType)&&!I(a.startContainer,!0))&&!(!g.arrayContains(M,a.endContainer.nodeType)&&!I(a.endContainer,!0))&&a.startOffset<=
(g.isCharacterDataNode(a.startContainer)?a.startContainer.length:a.startContainer.childNodes.length)&&a.endOffset<=(g.isCharacterDataNode(a.endContainer)?a.endContainer.length:a.endContainer.childNodes.length)}function u(a){y(a);if(!F(a))throw Error("Range error: Range is no longer valid after DOM mutation ("+a.inspect()+")");}function N(){}function G(a){a.START_TO_START=S;a.START_TO_END=W;a.END_TO_END=da;a.END_TO_START=X;a.NODE_BEFORE=Y;a.NODE_AFTER=Z;a.NODE_BEFORE_AND_AFTER=$;a.NODE_INSIDE=T}function E(a){G(a);
G(a.prototype)}function O(a,b){return function(){u(this);var c=this.startContainer,j=this.startOffset,h=this.commonAncestorContainer,k=new i(this,!0);c!==h&&(c=g.getClosestAncestorIn(c,h,!0),j=q(c),c=j.node,j=j.offset);e(k,C);k.reset();h=a(k);k.detach();b(this,c,j,c,j);return h}}function Q(a,c,e){function h(a,f){return function(b){y(this);B(b,J);B(j(b),M);b=(a?p:q)(b);(f?d:I)(this,b.node,b.offset)}}function d(a,f,b){var e=a.endContainer,h=a.endOffset;if(f!==a.startContainer||b!==a.startOffset){if(j(f)!=
j(e)||1==g.comparePoints(f,b,e,h))e=f,h=b;c(a,f,b,e,h)}}function I(a,f,b){var e=a.startContainer,h=a.startOffset;if(f!==a.endContainer||b!==a.endOffset){if(j(f)!=j(e)||-1==g.comparePoints(f,b,e,h))e=f,h=b;c(a,e,h,f,b)}}a.prototype=new N;b.util.extend(a.prototype,{setStart:function(a,f){y(this);z(a,!0);L(a,f);d(this,a,f)},setEnd:function(a,f){y(this);z(a,!0);L(a,f);I(this,a,f)},setStartBefore:h(!0,!0),setStartAfter:h(!1,!0),setEndBefore:h(!0,!1),setEndAfter:h(!1,!1),collapse:function(a){u(this);a?
c(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):c(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(a){y(this);z(a,!0);c(this,a,0,a,g.getNodeLength(a))},selectNode:function(a){y(this);z(a,!1);B(a,J);var f=p(a),a=q(a);c(this,f.node,f.offset,a.node,a.offset)},extractContents:O(l,c),deleteContents:O(k,c),canSurroundContents:function(){u(this);C(this.startContainer);C(this.endContainer);var a=new i(this,!0),f=a._first&&
t(a._first,this)||a._last&&t(a._last,this);a.detach();return!f},detach:function(){e(this)},splitBoundaries:function(){u(this);var a=this.startContainer,f=this.startOffset,b=this.endContainer,j=this.endOffset,e=a===b;g.isCharacterDataNode(b)&&0<j&&j<b.length&&g.splitDataNode(b,j);g.isCharacterDataNode(a)&&(0<f&&f<a.length)&&(a=g.splitDataNode(a,f),e?(j-=f,b=a):b==a.parentNode&&j>=g.getNodeIndex(a)&&j++,f=0);c(this,a,f,b,j)},normalizeBoundaries:function(){u(this);var a=this.startContainer,f=this.startOffset,
b=this.endContainer,j=this.endOffset,e=function(a){var f=a.nextSibling;f&&f.nodeType==a.nodeType&&(b=a,j=a.length,a.appendData(f.data),f.parentNode.removeChild(f))},h=function(c){var e=c.previousSibling;if(e&&e.nodeType==c.nodeType){a=c;var h=c.length;f=e.length;c.insertData(0,e.data);e.parentNode.removeChild(e);a==b?(j+=f,b=a):b==c.parentNode&&(e=g.getNodeIndex(c),j==e?(b=c,j=h):j>e&&j--)}},k=!0;g.isCharacterDataNode(b)?b.length==j&&e(b):(0<j&&(k=b.childNodes[j-1])&&g.isCharacterDataNode(k)&&e(k),
k=!this.collapsed);k?g.isCharacterDataNode(a)?0==f&&h(a):f<a.childNodes.length&&(e=a.childNodes[f])&&g.isCharacterDataNode(e)&&h(e):(a=b,f=j);c(this,a,f,b,j)},collapseToPoint:function(a,f){y(this);z(a,!0);L(a,f);(a!==this.startContainer||f!==this.startOffset||a!==this.endContainer||f!==this.endOffset)&&c(this,a,f,a,f)}});E(a)}function P(a){a.collapsed=a.startContainer===a.endContainer&&a.startOffset===a.endOffset;a.commonAncestorContainer=a.collapsed?a.startContainer:g.getCommonAncestor(a.startContainer,
a.endContainer)}function R(a,b,c,j,e){var h=a.startContainer!==b||a.startOffset!==c,k=a.endContainer!==j||a.endOffset!==e;a.startContainer=b;a.startOffset=c;a.endContainer=j;a.endOffset=e;P(a);s(a,"boundarychange",{startMoved:h,endMoved:k})}function w(a){this.startContainer=a;this.startOffset=0;this.endContainer=a;this.endOffset=0;this._listeners={boundarychange:[],detach:[]};P(this)}b.requireModules(["DomUtil"]);var g=b.dom,H=g.DomPosition,A=b.DOMException;i.prototype={_current:null,_next:null,_first:null,
_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null;this._next=this._first},hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next;a&&(this._next=a!==this._last?a.nextSibling:null,g.isCharacterDataNode(a)&&this.clonePartiallySelectedTextNodes&&(a===this.ec&&(a=a.cloneNode(!0)).deleteData(this.eo,a.length-this.eo),this._current===this.sc&&(a=a.cloneNode(!0)).deleteData(0,this.so)));return a},remove:function(){var a=this._current,b,c;g.isCharacterDataNode(a)&&
(a===this.sc||a===this.ec)?(b=a===this.sc?this.so:0,c=a===this.ec?this.eo:a.length,b!=c&&a.deleteData(b,c-b)):a.parentNode&&a.parentNode.removeChild(a)},isPartiallySelectedSubtree:function(){return t(this._current,this.range)},getSubtreeIterator:function(){var a;if(this.isSingleCharacterDataNode)a=this.range.cloneRange(),a.collapse();else{a=new w(r(this.range));var b=this._current,c=b,j=0,e=b,h=g.getNodeLength(b);g.isAncestorOf(b,this.sc,!0)&&(c=this.sc,j=this.so);g.isAncestorOf(b,this.ec,!0)&&(e=
this.ec,h=this.eo);R(a,c,j,e,h)}return new i(a,this.clonePartiallySelectedTextNodes)},detach:function(a){a&&this.range.detach();this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};n.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2};n.prototype.toString=function(){return this.message};c.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){this._current=this._next;this._next=this.nodes[++this._position];return this._current},
detach:function(){this._current=this._next=this.nodes=null}};var J=[1,3,4,5,7,8,10],M=[2,9,11],K=[1,3,4,5,7,8,10,11],a=[1,3,4,5,7,8],j=g.getRootContainer,I=h([9,11]),ca=h([5,6,10,12]),ba=h([6,10,12]),aa=document.createElement("style"),U=!1;try{aa.innerHTML="<b>x</b>",U=3==aa.firstChild.nodeType}catch(ea){}b.features.htmlParsingConforms=U;var V="startContainer startOffset endContainer endOffset collapsed commonAncestorContainer".split(" "),S=0,W=1,da=2,X=3,Y=0,Z=1,$=2,T=3;N.prototype={attachListener:function(a,
b){this._listeners[a].push(b)},compareBoundaryPoints:function(a,b){u(this);D(this.startContainer,b.startContainer);var c=a==X||a==S?"start":"end",j=a==W||a==S?"start":"end";return g.comparePoints(this[c+"Container"],this[c+"Offset"],b[j+"Container"],b[j+"Offset"])},insertNode:function(a){u(this);B(a,K);C(this.startContainer);if(g.isAncestorOf(a,this.startContainer,!0))throw new A("HIERARCHY_REQUEST_ERR");this.setStartBefore(v(a,this.startContainer,this.startOffset))},cloneContents:function(){u(this);
var a,b;if(this.collapsed)return r(this).createDocumentFragment();if(this.startContainer===this.endContainer&&g.isCharacterDataNode(this.startContainer))return a=this.startContainer.cloneNode(!0),a.data=a.data.slice(this.startOffset,this.endOffset),b=r(this).createDocumentFragment(),b.appendChild(a),b;b=new i(this,!0);a=d(b);b.detach();return a},canSurroundContents:function(){u(this);C(this.startContainer);C(this.endContainer);var a=new i(this,!0),b=a._first&&t(a._first,this)||a._last&&t(a._last,
this);a.detach();return!b},surroundContents:function(b){B(b,a);if(!this.canSurroundContents())throw new n("BAD_BOUNDARYPOINTS_ERR");var c=this.extractContents();if(b.hasChildNodes())for(;b.lastChild;)b.removeChild(b.lastChild);v(b,this.startContainer,this.startOffset);b.appendChild(c);this.selectNode(b)},cloneRange:function(){u(this);for(var a=new w(r(this)),b=V.length,c;b--;)c=V[b],a[c]=this[c];return a},toString:function(){u(this);var a=this.startContainer;if(a===this.endContainer&&g.isCharacterDataNode(a))return 3==
a.nodeType||4==a.nodeType?a.data.slice(this.startOffset,this.endOffset):"";var b=[],a=new i(this,!0);e(a,function(a){(3==a.nodeType||4==a.nodeType)&&b.push(a.data)});a.detach();return b.join("")},compareNode:function(a){u(this);var b=a.parentNode,c=g.getNodeIndex(a);if(!b)throw new A("NOT_FOUND_ERR");a=this.comparePoint(b,c);b=this.comparePoint(b,c+1);return 0>a?0<b?$:Y:0<b?Z:T},comparePoint:function(a,b){u(this);x(a,"HIERARCHY_REQUEST_ERR");D(a,this.startContainer);return 0>g.comparePoints(a,b,this.startContainer,
this.startOffset)?-1:0<g.comparePoints(a,b,this.endContainer,this.endOffset)?1:0},createContextualFragment:U?function(a){var b=this.startContainer,c=g.getDocument(b);if(!b)throw new A("INVALID_STATE_ERR");var j=null;1==b.nodeType?j=b:g.isCharacterDataNode(b)&&(j=g.parentElement(b));j=null===j||"HTML"==j.nodeName&&g.isHtmlNamespace(g.getDocument(j).documentElement)&&g.isHtmlNamespace(j)?c.createElement("body"):j.cloneNode(!1);j.innerHTML=a;return g.fragmentFromNodeChildren(j)}:function(a){y(this);
var b=r(this).createElement("body");b.innerHTML=a;return g.fragmentFromNodeChildren(b)},toHtml:function(){u(this);var a=r(this).createElement("div");a.appendChild(this.cloneContents());return a.innerHTML},intersectsNode:function(a,b){u(this);x(a,"NOT_FOUND_ERR");if(g.getDocument(a)!==r(this))return!1;var c=a.parentNode,j=g.getNodeIndex(a);x(c,"NOT_FOUND_ERR");var e=g.comparePoints(c,j,this.endContainer,this.endOffset),c=g.comparePoints(c,j+1,this.startContainer,this.startOffset);return b?0>=e&&0<=
c:0>e&&0<c},isPointInRange:function(a,b){u(this);x(a,"HIERARCHY_REQUEST_ERR");D(a,this.startContainer);return 0<=g.comparePoints(a,b,this.startContainer,this.startOffset)&&0>=g.comparePoints(a,b,this.endContainer,this.endOffset)},intersectsRange:function(a,b){u(this);if(r(a)!=r(this))throw new A("WRONG_DOCUMENT_ERR");var c=g.comparePoints(this.startContainer,this.startOffset,a.endContainer,a.endOffset),j=g.comparePoints(this.endContainer,this.endOffset,a.startContainer,a.startOffset);return b?0>=
c&&0<=j:0>c&&0<j},intersection:function(a){if(this.intersectsRange(a)){var b=g.comparePoints(this.startContainer,this.startOffset,a.startContainer,a.startOffset),c=g.comparePoints(this.endContainer,this.endOffset,a.endContainer,a.endOffset),j=this.cloneRange();-1==b&&j.setStart(a.startContainer,a.startOffset);1==c&&j.setEnd(a.endContainer,a.endOffset);return j}return null},union:function(a){if(this.intersectsRange(a,!0)){var b=this.cloneRange();-1==g.comparePoints(a.startContainer,a.startOffset,this.startContainer,
this.startOffset)&&b.setStart(a.startContainer,a.startOffset);1==g.comparePoints(a.endContainer,a.endOffset,this.endContainer,this.endOffset)&&b.setEnd(a.endContainer,a.endOffset);return b}throw new n("Ranges do not intersect");},containsNode:function(a,b){return b?this.intersectsNode(a,!1):this.compareNode(a)==T},containsNodeContents:function(a){return 0<=this.comparePoint(a,0)&&0>=this.comparePoint(a,g.getNodeLength(a))},containsRange:function(a){return this.intersection(a).equals(a)},containsNodeText:function(a){var b=
this.cloneRange();b.selectNode(a);var c=b.getNodes([3]);return 0<c.length?(b.setStart(c[0],0),a=c.pop(),b.setEnd(a,a.length),a=this.containsRange(b),b.detach(),a):this.containsNodeContents(a)},createNodeIterator:function(a,b){u(this);return new c(this,a,b)},getNodes:function(a,b){u(this);return m(this,a,b)},getDocument:function(){return r(this)},collapseBefore:function(a){y(this);this.setEndBefore(a);this.collapse(!1)},collapseAfter:function(a){y(this);this.setStartAfter(a);this.collapse(!0)},getName:function(){return"DomRange"},
equals:function(a){return w.rangesEqual(this,a)},isValid:function(){return F(this)},inspect:function(){return o(this)}};Q(w,R,function(a){y(a);a.startContainer=a.startOffset=a.endContainer=a.endOffset=null;a.collapsed=a.commonAncestorContainer=null;s(a,"detach",null);a._listeners=null});b.rangePrototype=N.prototype;w.rangeProperties=V;w.RangeIterator=i;w.copyComparisonConstants=E;w.createPrototypeRange=Q;w.inspect=o;w.getRangeDocument=r;w.rangesEqual=function(a,b){return a.startContainer===b.startContainer&&
a.startOffset===b.startOffset&&a.endContainer===b.endContainer&&a.endOffset===b.endOffset};b.DomRange=w;b.RangeException=n});
rangy.createModule("WrappedRange",function(b){function t(b,k,d,m){var o=b.duplicate();o.collapse(d);var i=o.parentElement();p.isAncestorOf(k,i,!0)||(i=k);if(!i.canHaveHTML)return new q(i.parentNode,p.getNodeIndex(i));var k=p.getDocument(i).createElement("span"),n,c=d?"StartToStart":"StartToEnd";do i.insertBefore(k,k.previousSibling),o.moveToElementText(k);while(0<(n=o.compareEndPoints(c,b))&&k.previousSibling);c=k.nextSibling;if(-1==n&&c&&p.isCharacterDataNode(c)){o.setEndPoint(d?"EndToStart":"EndToEnd",
b);if(/[\r\n]/.test(c.data)){i=o.duplicate();d=i.text.replace(/\r\n/g,"\r").length;for(d=i.moveStart("character",d);-1==i.compareEndPoints("StartToEnd",i);)d++,i.moveStart("character",1)}else d=o.text.length;i=new q(c,d)}else c=(m||!d)&&k.previousSibling,i=(d=(m||d)&&k.nextSibling)&&p.isCharacterDataNode(d)?new q(d,0):c&&p.isCharacterDataNode(c)?new q(c,c.length):new q(i,p.getNodeIndex(k));k.parentNode.removeChild(k);return i}function r(b,k){var d,m,o=b.offset,i=p.getDocument(b.node),n=i.body.createTextRange(),
c=p.isCharacterDataNode(b.node);c?(d=b.node,m=d.parentNode):(d=b.node.childNodes,d=o<d.length?d[o]:null,m=b.node);i=i.createElement("span");i.innerHTML="&#feff;";d?m.insertBefore(i,d):m.appendChild(i);n.moveToElementText(i);n.collapse(!k);m.removeChild(i);if(c)n[k?"moveStart":"moveEnd"]("character",o);return n}b.requireModules(["DomUtil","DomRange"]);var s,p=b.dom,q=p.DomPosition,v=b.DomRange;if(b.features.implementsDomRange&&(!b.features.implementsTextRange||!b.config.preferTextRange))(function(){function e(b){for(var c=
l.length,e;c--;)e=l[c],b[e]=b.nativeRange[e]}var d,l=v.rangeProperties,m,o;s=function(b){if(!b)throw Error("Range must be specified");this.nativeRange=b;e(this)};v.createPrototypeRange(s,function(b,c,e,d,k){var i=b.endContainer!==d||b.endOffset!=k;if(b.startContainer!==c||b.startOffset!=e||i)b.setEnd(d,k),b.setStart(c,e)},function(b){b.nativeRange.detach();b.detached=!0;for(var c=l.length,e;c--;)e=l[c],b[e]=null});d=s.prototype;d.selectNode=function(b){this.nativeRange.selectNode(b);e(this)};d.deleteContents=
function(){this.nativeRange.deleteContents();e(this)};d.extractContents=function(){var b=this.nativeRange.extractContents();e(this);return b};d.cloneContents=function(){return this.nativeRange.cloneContents()};d.surroundContents=function(b){this.nativeRange.surroundContents(b);e(this)};d.collapse=function(b){this.nativeRange.collapse(b);e(this)};d.cloneRange=function(){return new s(this.nativeRange.cloneRange())};d.refresh=function(){e(this)};d.toString=function(){return this.nativeRange.toString()};
var i=document.createTextNode("test");p.getBody(document).appendChild(i);var n=document.createRange();n.setStart(i,0);n.setEnd(i,0);try{n.setStart(i,1),m=!0,d.setStart=function(b,c){this.nativeRange.setStart(b,c);e(this)},d.setEnd=function(b,c){this.nativeRange.setEnd(b,c);e(this)},o=function(b){return function(c){this.nativeRange[b](c);e(this)}}}catch(c){m=!1,d.setStart=function(b,c){try{this.nativeRange.setStart(b,c)}catch(d){this.nativeRange.setEnd(b,c),this.nativeRange.setStart(b,c)}e(this)},
d.setEnd=function(b,c){try{this.nativeRange.setEnd(b,c)}catch(d){this.nativeRange.setStart(b,c),this.nativeRange.setEnd(b,c)}e(this)},o=function(b,c){return function(d){try{this.nativeRange[b](d)}catch(k){this.nativeRange[c](d),this.nativeRange[b](d)}e(this)}}}d.setStartBefore=o("setStartBefore","setEndBefore");d.setStartAfter=o("setStartAfter","setEndAfter");d.setEndBefore=o("setEndBefore","setStartBefore");d.setEndAfter=o("setEndAfter","setStartAfter");n.selectNodeContents(i);d.selectNodeContents=
n.startContainer==i&&n.endContainer==i&&0==n.startOffset&&n.endOffset==i.length?function(b){this.nativeRange.selectNodeContents(b);e(this)}:function(b){this.setStart(b,0);this.setEnd(b,v.getEndOffset(b))};n.selectNodeContents(i);n.setEnd(i,3);m=document.createRange();m.selectNodeContents(i);m.setEnd(i,4);m.setStart(i,2);d.compareBoundaryPoints=-1==n.compareBoundaryPoints(n.START_TO_END,m)&1==n.compareBoundaryPoints(n.END_TO_START,m)?function(b,c){c=c.nativeRange||c;b==c.START_TO_END?b=c.END_TO_START:
b==c.END_TO_START&&(b=c.START_TO_END);return this.nativeRange.compareBoundaryPoints(b,c)}:function(b,c){return this.nativeRange.compareBoundaryPoints(b,c.nativeRange||c)};b.util.isHostMethod(n,"createContextualFragment")&&(d.createContextualFragment=function(b){return this.nativeRange.createContextualFragment(b)});p.getBody(document).removeChild(i);n.detach();m.detach()})(),b.createNativeRange=function(b){b=b||document;return b.createRange()};else if(b.features.implementsTextRange){s=function(b){this.textRange=
b;this.refresh()};s.prototype=new v(document);s.prototype.refresh=function(){var b,d,l=this.textRange;b=l.parentElement();var m=l.duplicate();m.collapse(!0);d=m.parentElement();m=l.duplicate();m.collapse(!1);l=m.parentElement();d=d==l?d:p.getCommonAncestor(d,l);d=d==b?d:p.getCommonAncestor(b,d);0==this.textRange.compareEndPoints("StartToEnd",this.textRange)?d=b=t(this.textRange,d,!0,!0):(b=t(this.textRange,d,!0,!1),d=t(this.textRange,d,!1,!1));this.setStart(b.node,b.offset);this.setEnd(d.node,d.offset)};
v.copyComparisonConstants(s);var d=function(){return this}();"undefined"==typeof d.Range&&(d.Range=s);b.createNativeRange=function(b){b=b||document;return b.body.createTextRange()}}b.features.implementsTextRange&&(s.rangeToTextRange=function(b){if(b.collapsed)return r(new q(b.startContainer,b.startOffset),!0);var d=r(new q(b.startContainer,b.startOffset),!0),l=r(new q(b.endContainer,b.endOffset),!1),b=p.getDocument(b.startContainer).body.createTextRange();b.setEndPoint("StartToStart",d);b.setEndPoint("EndToEnd",
l);return b});s.prototype.getName=function(){return"WrappedRange"};b.WrappedRange=s;b.createRange=function(d){d=d||document;return new s(b.createNativeRange(d))};b.createRangyRange=function(b){b=b||document;return new v(b)};b.createIframeRange=function(d){return b.createRange(p.getIframeDocument(d))};b.createIframeRangyRange=function(d){return b.createRangyRange(p.getIframeDocument(d))};b.addCreateMissingNativeApiListener(function(d){d=d.document;if(typeof d.createRange=="undefined")d.createRange=
function(){return b.createRange(this)};d=d=null})});
rangy.createModule("WrappedSelection",function(b,t){function r(a){return(a||window).getSelection()}function s(a){return(a||window).document.selection}function p(a,b,c){var d=c?"end":"start",c=c?"start":"end";a.anchorNode=b[d+"Container"];a.anchorOffset=b[d+"Offset"];a.focusNode=b[c+"Container"];a.focusOffset=b[c+"Offset"]}function q(a){a.anchorNode=a.focusNode=null;a.anchorOffset=a.focusOffset=0;a.rangeCount=0;a.isCollapsed=!0;a._ranges.length=0}function v(a){var j;a instanceof z?(j=a._selectionNativeRange,
j||(j=b.createNativeRange(c.getDocument(a.startContainer)),j.setEnd(a.endContainer,a.endOffset),j.setStart(a.startContainer,a.startOffset),a._selectionNativeRange=j,a.attachListener("detach",function(){this._selectionNativeRange=null}))):a instanceof y?j=a.nativeRange:b.features.implementsDomRange&&a instanceof c.getWindow(a.startContainer).Range&&(j=a);return j}function d(a){var b=a.getNodes(),d;a:if(!b.length||1!=b[0].nodeType)d=!1;else{d=1;for(var e=b.length;d<e;++d)if(!c.isAncestorOf(b[0],b[d])){d=
!1;break a}d=!0}if(!d)throw Error("getSingleElementFromRange: range "+a.inspect()+" did not consist of a single element");return b[0]}function e(a,b){var c=new y(b);a._ranges=[c];p(a,c,!1);a.rangeCount=1;a.isCollapsed=c.collapsed}function k(a){a._ranges.length=0;if("None"==a.docSelection.type)q(a);else{var j=a.docSelection.createRange();if(j&&"undefined"!=typeof j.text)e(a,j);else{a.rangeCount=j.length;for(var d,g=c.getDocument(j.item(0)),h=0;h<a.rangeCount;++h)d=b.createRange(g),d.selectNode(j.item(h)),
a._ranges.push(d);a.isCollapsed=1==a.rangeCount&&a._ranges[0].collapsed;p(a,a._ranges[a.rangeCount-1],!1)}}}function l(a,b){for(var e=a.docSelection.createRange(),g=d(b),h=c.getDocument(e.item(0)),h=c.getBody(h).createControlRange(),i=0,l=e.length;i<l;++i)h.add(e.item(i));try{h.add(g)}catch(m){throw Error("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)");}h.select();k(a)}function m(a,b,c){this.nativeSelection=a;this.docSelection=b;this._ranges=
[];this.win=c;this.refresh()}function o(a,b){for(var e=c.getDocument(b[0].startContainer),e=c.getBody(e).createControlRange(),g=0,h;g<rangeCount;++g){h=d(b[g]);try{e.add(h)}catch(i){throw Error("setRanges(): Element within the one of the specified Ranges could not be added to control selection (does it have layout?)");}}e.select();k(a)}function i(a,b){if(a.anchorNode&&c.getDocument(a.anchorNode)!==c.getDocument(b))throw new B("WRONG_DOCUMENT_ERR");}function n(a){var b=[],c=new L(a.anchorNode,a.anchorOffset),
d=new L(a.focusNode,a.focusOffset),e="function"==typeof a.getName?a.getName():"Selection";if("undefined"!=typeof a.rangeCount)for(var g=0,h=a.rangeCount;g<h;++g)b[g]=z.inspect(a.getRangeAt(g));return"["+e+"(Ranges: "+b.join(", ")+")(anchor: "+c.inspect()+", focus: "+d.inspect()+"]"}b.requireModules(["DomUtil","DomRange","WrappedRange"]);b.config.checkSelectionRanges=!0;var c=b.dom,h=b.util,z=b.DomRange,y=b.WrappedRange,B=b.DOMException,L=c.DomPosition,D,C,x=b.util.isHostMethod(window,"getSelection"),
F=b.util.isHostObject(document,"selection"),u=F&&(!x||b.config.preferTextRange);u?(D=s,b.isSelectionValid=function(a){var a=(a||window).document,b=a.selection;return"None"!=b.type||c.getDocument(b.createRange().parentElement())==a}):x?(D=r,b.isSelectionValid=function(){return!0}):t.fail("Neither document.selection or window.getSelection() detected.");b.getNativeSelection=D;var x=D(),N=b.createNativeRange(document),G=c.getBody(document),E=h.areHostObjects(x,h.areHostProperties(x,["anchorOffset","focusOffset"]));
b.features.selectionHasAnchorAndFocus=E;var O=h.isHostMethod(x,"extend");b.features.selectionHasExtend=O;var Q="number"==typeof x.rangeCount;b.features.selectionHasRangeCount=Q;var P=!1,R=!0;h.areHostMethods(x,["addRange","getRangeAt","removeAllRanges"])&&"number"==typeof x.rangeCount&&b.features.implementsDomRange&&function(){var a=document.createElement("iframe");a.frameBorder=0;a.style.position="absolute";a.style.left="-10000px";G.appendChild(a);var b=c.getIframeDocument(a);b.open();b.write("<html><head></head><body>12</body></html>");
b.close();var d=c.getIframeWindow(a).getSelection(),e=b.documentElement.lastChild.firstChild,b=b.createRange();b.setStart(e,1);b.collapse(true);d.addRange(b);R=d.rangeCount==1;d.removeAllRanges();var g=b.cloneRange();b.setStart(e,0);g.setEnd(e,2);d.addRange(b);d.addRange(g);P=d.rangeCount==2;b.detach();g.detach();G.removeChild(a)}();b.features.selectionSupportsMultipleRanges=P;b.features.collapsedNonEditableSelectionsSupported=R;var w=!1,g;G&&h.isHostMethod(G,"createControlRange")&&(g=G.createControlRange(),
h.areHostProperties(g,["item","add"])&&(w=!0));b.features.implementsControlRange=w;C=E?function(a){return a.anchorNode===a.focusNode&&a.anchorOffset===a.focusOffset}:function(a){return a.rangeCount?a.getRangeAt(a.rangeCount-1).collapsed:false};var H;h.isHostMethod(x,"getRangeAt")?H=function(a,b){try{return a.getRangeAt(b)}catch(c){return null}}:E&&(H=function(a){var d=c.getDocument(a.anchorNode),d=b.createRange(d);d.setStart(a.anchorNode,a.anchorOffset);d.setEnd(a.focusNode,a.focusOffset);if(d.collapsed!==
this.isCollapsed){d.setStart(a.focusNode,a.focusOffset);d.setEnd(a.anchorNode,a.anchorOffset)}return d});b.getSelection=function(a){var a=a||window,b=a._rangySelection,c=D(a),d=F?s(a):null;if(b){b.nativeSelection=c;b.docSelection=d;b.refresh(a)}else{b=new m(c,d,a);a._rangySelection=b}return b};b.getIframeSelection=function(a){return b.getSelection(c.getIframeWindow(a))};g=m.prototype;if(!u&&E&&h.areHostMethods(x,["removeAllRanges","addRange"])){g.removeAllRanges=function(){this.nativeSelection.removeAllRanges();
q(this)};var A=function(a,c){var d=z.getRangeDocument(c),d=b.createRange(d);d.collapseToPoint(c.endContainer,c.endOffset);a.nativeSelection.addRange(v(d));a.nativeSelection.extend(c.startContainer,c.startOffset);a.refresh()};g.addRange=Q?function(a,c){if(w&&F&&this.docSelection.type=="Control")l(this,a);else if(c&&O)A(this,a);else{var d;if(P)d=this.rangeCount;else{this.removeAllRanges();d=0}this.nativeSelection.addRange(v(a));this.rangeCount=this.nativeSelection.rangeCount;if(this.rangeCount==d+1){if(b.config.checkSelectionRanges&&
(d=H(this.nativeSelection,this.rangeCount-1))&&!z.rangesEqual(d,a))a=new y(d);this._ranges[this.rangeCount-1]=a;p(this,a,K(this.nativeSelection));this.isCollapsed=C(this)}else this.refresh()}}:function(a,b){if(b&&O)A(this,a);else{this.nativeSelection.addRange(v(a));this.refresh()}};g.setRanges=function(a){if(w&&a.length>1)o(this,a);else{this.removeAllRanges();for(var b=0,c=a.length;b<c;++b)this.addRange(a[b])}}}else if(h.isHostMethod(x,"empty")&&h.isHostMethod(N,"select")&&w&&u)g.removeAllRanges=
function(){try{this.docSelection.empty();if(this.docSelection.type!="None"){var a;if(this.anchorNode)a=c.getDocument(this.anchorNode);else if(this.docSelection.type=="Control"){var b=this.docSelection.createRange();b.length&&(a=c.getDocument(b.item(0)).body.createTextRange())}if(a){a.body.createTextRange().select();this.docSelection.empty()}}}catch(d){}q(this)},g.addRange=function(a){if(this.docSelection.type=="Control")l(this,a);else{y.rangeToTextRange(a).select();this._ranges[0]=a;this.rangeCount=
1;this.isCollapsed=this._ranges[0].collapsed;p(this,a,false)}},g.setRanges=function(a){this.removeAllRanges();var b=a.length;b>1?o(this,a):b&&this.addRange(a[0])};else return t.fail("No means of selecting a Range or TextRange was found"),!1;g.getRangeAt=function(a){if(a<0||a>=this.rangeCount)throw new B("INDEX_SIZE_ERR");return this._ranges[a]};var J;if(u)J=function(a){var d;if(b.isSelectionValid(a.win))d=a.docSelection.createRange();else{d=c.getBody(a.win.document).createTextRange();d.collapse(true)}a.docSelection.type==
"Control"?k(a):d&&typeof d.text!="undefined"?e(a,d):q(a)};else if(h.isHostMethod(x,"getRangeAt")&&"number"==typeof x.rangeCount)J=function(a){if(w&&F&&a.docSelection.type=="Control")k(a);else{a._ranges.length=a.rangeCount=a.nativeSelection.rangeCount;if(a.rangeCount){for(var c=0,d=a.rangeCount;c<d;++c)a._ranges[c]=new b.WrappedRange(a.nativeSelection.getRangeAt(c));p(a,a._ranges[a.rangeCount-1],K(a.nativeSelection));a.isCollapsed=C(a)}else q(a)}};else if(E&&"boolean"==typeof x.isCollapsed&&"boolean"==
typeof N.collapsed&&b.features.implementsDomRange)J=function(a){var b;b=a.nativeSelection;if(b.anchorNode){b=H(b,0);a._ranges=[b];a.rangeCount=1;b=a.nativeSelection;a.anchorNode=b.anchorNode;a.anchorOffset=b.anchorOffset;a.focusNode=b.focusNode;a.focusOffset=b.focusOffset;a.isCollapsed=C(a)}else q(a)};else return t.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;g.refresh=function(a){var b=a?this._ranges.slice(0):null;J(this);if(a){a=b.length;if(a!=this._ranges.length)return false;
for(;a--;)if(!z.rangesEqual(b[a],this._ranges[a]))return false;return true}};var M=function(a,b){var c=a.getAllRanges(),d=false;a.removeAllRanges();for(var e=0,g=c.length;e<g;++e)d||b!==c[e]?a.addRange(c[e]):d=true;a.rangeCount||q(a)};g.removeRange=w?function(a){if(this.docSelection.type=="Control"){for(var b=this.docSelection.createRange(),a=d(a),e=c.getDocument(b.item(0)),e=c.getBody(e).createControlRange(),g,h=false,i=0,l=b.length;i<l;++i){g=b.item(i);g!==a||h?e.add(b.item(i)):h=true}e.select();
k(this)}else M(this,a)}:function(a){M(this,a)};var K;!u&&E&&b.features.implementsDomRange?(K=function(a){var b=false;a.anchorNode&&(b=c.comparePoints(a.anchorNode,a.anchorOffset,a.focusNode,a.focusOffset)==1);return b},g.isBackwards=function(){return K(this)}):K=g.isBackwards=function(){return false};g.toString=function(){for(var a=[],b=0,c=this.rangeCount;b<c;++b)a[b]=""+this._ranges[b];return a.join("")};g.collapse=function(a,d){i(this,a);var e=b.createRange(c.getDocument(a));e.collapseToPoint(a,
d);this.removeAllRanges();this.addRange(e);this.isCollapsed=true};g.collapseToStart=function(){if(this.rangeCount){var a=this._ranges[0];this.collapse(a.startContainer,a.startOffset)}else throw new B("INVALID_STATE_ERR");};g.collapseToEnd=function(){if(this.rangeCount){var a=this._ranges[this.rangeCount-1];this.collapse(a.endContainer,a.endOffset)}else throw new B("INVALID_STATE_ERR");};g.selectAllChildren=function(a){i(this,a);var d=b.createRange(c.getDocument(a));d.selectNodeContents(a);this.removeAllRanges();
this.addRange(d)};g.deleteFromDocument=function(){if(w&&F&&this.docSelection.type=="Control"){for(var a=this.docSelection.createRange(),b;a.length;){b=a.item(0);a.remove(b);b.parentNode.removeChild(b)}this.refresh()}else if(this.rangeCount){a=this.getAllRanges();this.removeAllRanges();b=0;for(var c=a.length;b<c;++b)a[b].deleteContents();this.addRange(a[c-1])}};g.getAllRanges=function(){return this._ranges.slice(0)};g.setSingleRange=function(a){this.setRanges([a])};g.containsNode=function(a,b){for(var c=
0,d=this._ranges.length;c<d;++c)if(this._ranges[c].containsNode(a,b))return true;return false};g.toHtml=function(){var a="";if(this.rangeCount){for(var a=z.getRangeDocument(this._ranges[0]).createElement("div"),b=0,c=this._ranges.length;b<c;++b)a.appendChild(this._ranges[b].cloneContents());a=a.innerHTML}return a};g.getName=function(){return"WrappedSelection"};g.inspect=function(){return n(this)};g.detach=function(){this.win=this.anchorNode=this.focusNode=this.win._rangySelection=null};m.inspect=
n;b.Selection=m;b.selectionPrototype=g;b.addCreateMissingNativeApiListener(function(a){if(typeof a.getSelection=="undefined")a.getSelection=function(){return b.getSelection(this)};a=null})});
