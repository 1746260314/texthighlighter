(function(c){function l(){var a;a=window.getSelection?window.getSelection():rangy.getSelection();var e=null;a.rangeCount>0&&(e=a.getRangeAt(0));if((a=e)&&!a.collapsed){e=c.fn.textHighlighter.createWrapper(h);if(!a.collapsed){var i=["SCRIPT","STYLE","SELECT","BUTTON","OBJECT","APPLET"],b=a.startContainer,d=a.endContainer,g=a.commonAncestorContainer,f=!0;if(a.endOffset==0){for(;!d.previousSibling&&d.parentNode!=g;)d=d.parentNode;d=d.previousSibling}else d.nodeType==j.TEXT_NODE?a.endOffset<d.nodeValue.length&&
d.splitText(a.endOffset):a.endOffset>0&&(d=d.childNodes.item(a.endOffset-1));b.nodeType==j.TEXT_NODE?a.startOffset==b.nodeValue.length?f=!1:a.startOffset>0&&(b=b.splitText(a.startOffset),d==b.previousSibling&&(d=b)):b=a.startOffset<b.childNodes.length?b.childNodes.item(a.startOffset):b.nextSibling;var g=!1,k=[];do{f&&b.nodeType==j.TEXT_NODE&&(/\S/.test(b.nodeValue)&&(f=e.get(0),c(b).wrap(f),k.push(f)),f=!1);if(b==d&&(!d.hasChildNodes()||!f))g=!0;c.inArray(b.tagName,i)!=-1&&(f=!1);if(f&&b.hasChildNodes())b=
b.firstChild;else if(b.nextSibling!=null)b=b.nextSibling,f=!0;else if(b.nextSibling==null)b=b.parentNode,f=!1}while(!g)}h.normalizeHighlights&&(a=c(a.commonAncestorContainer.nodeType==j.TEXT_NODE?a.commonAncestorContainer.parentNode.parentNode:a.commonAncestorContainer.parentNode).find("."+h.highlightedClass),a.length>1&&(m(a),n(a)));(window.getSelection?window.getSelection():rangy.getSelection()).removeAllRanges()}}function m(a){c.each(a,function(e){var i=c(this);if(i.parent().hasClass(h.highlightedClass)){var i=
i.parent(),b=i.text(),b=document.createTextNode(b);i.empty();i.append(b);a[e]=void 0}})}function n(a){function e(a){return a&&a.nodeType==j.ELEMENT_NODE&&c(a).hasClass(h.highlightedClass)?!0:!1}c.each(a,function(){var a=this.previousSibling,b=this.nextSibling;if(e(a)){var d=c(a).text()+c(this).text();c(this).text(d);c(a).remove()}e(b)&&(d=c(this).text()+c(b).text(),c(this).text(d),c(b).remove())})}var g=null,h={},k={init:function(a){g=this;h=c.extend({},c.fn.textHighlighter.defaults,a);c(g).addClass(h.contextClass);
c(g).mouseup(l)},destroy:function(){c(g).unbind("mouseup",l);c(g).removeClass(h.contextClass)}},j={ELEMENT_NODE:1,TEXT_NODE:3};c.fn.textHighlighter=function(a){var e=arguments;return this.each(function(){if(k[a])return k[a].apply(this,Array.prototype.slice.call(e,1));else if(typeof a==="object"||!a)return k.init.apply(this,e);else c.error("Method "+a+" does not exist on jQuery.textHighlighter")})};c.fn.textHighlighter.createWrapper=function(a){return c("<span>").css("backgroundColor",a.color).addClass(a.highlightedClass)};
c.fn.textHighlighter.defaults={color:"#ffff7b",highlightedClass:"highlighted",contextClass:"highlighter-context",normalizeHighlights:!0,beforeHighlight:function(){},afterHighlight:function(){}}})(jQuery);
